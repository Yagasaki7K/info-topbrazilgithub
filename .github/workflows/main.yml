name: Update Top GitHub Users

on:
  schedule:
    - cron: "0 * * * 1-5"  # Executa a cada hora, de segunda a sexta-feira
  workflow_dispatch:  # Permite execução manual

permissions:
  contents: write  # Permite escrita no repositório

jobs:
  update-users:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install PyGithub
      run: |
        pip install PyGithub

    - name: Run the update script and update README
      run: |
        python - <<EOF
        from github import Github
        from datetime import datetime, timedelta
        import time
        import os

        # Inicialize o cliente GitHub com o token do ambiente
        g = Github(os.getenv('GITHUB_TOKEN'))

        def handle_rate_limit_exceeded():
            rate_limit = g.get_rate_limit().core
            if rate_limit.remaining == 0:
                reset_time = rate_limit.reset - datetime.now()
                sleep_time = max(reset_time.total_seconds(), 0)
                print(f"Rate limit exceeded. Sleeping for {sleep_time} seconds.")
                time.sleep(sleep_time)

        # Busque usuários
        query = 'location:Brazil sort:followers-desc'
        try:
            result = g.search_users(query)[:50]  # Agora para os 50 melhores usuários
        except Exception as e:
            print(f"Error fetching users: {e}")
            result = []

        top_users = []
        for user in result:
            handle_rate_limit_exceeded()  # Verifique o limite antes de cada requisição

            name = user.name or "N/A"
            company = user.company or "N/A"
            twitter_username = user.twitter_username or "N/A"
            location = user.location or "N/A"
            repositories = user.public_repos

            # Calcular o número de commits na última semana
            one_week_ago = datetime.now() - timedelta(days=7)
            commits_last_week = 0
            try:
                for repo in user.get_repos():
                    handle_rate_limit_exceeded()
                    commits = repo.get_commits(since=one_week_ago)
                    commits_last_week += commits.totalCount
            except Exception as e:
                print(f"Error fetching commits for user {user.login}: {e}")

            user_info = f"| [{name}](https://github.com/{user.login}) | {company} | {twitter_username} | {location} | {repositories} | {commits_last_week} |"
            top_users.append(user_info)

        # Ordenar os usuários pela quantidade de commits na semana, em ordem decrescente
        top_users.sort(key=lambda x: int(x.split('|')[-2].strip()), reverse=True)

        # Conteúdo a ser inserido no README.md
        top_users_content = "\n".join(top_users)
        new_content = f"<!-- START TOP USERS -->\n| Name | Company | Twitter Username | Location | Repositories | Commits Last Week |\n|------|---------|------------------|----------|--------------|-------------------|\n{top_users_content}\n<!-- END TOP USERS -->"

        # Ler e atualizar o README.md
        with open('README.md', 'r') as file:
            readme_content = file.read()

        updated_readme = readme_content.split('<!-- START TOP USERS -->')[0] + new_content + readme_content.split('<!-- END TOP USERS -->')[1]

        with open('README.md', 'w') as file:
            file.write(updated_readme)
        EOF

    - name: Configure Git user
      run: |
        git config --global user.email "anderson18.marlon@gmail.com"
        git config --global user.name "GitHub Actions"

    - name: Commit and push changes
      run: |
        git add README.md
        git commit -m "Update Top 50 Brazilian GitHub Users [skip ci]"
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
